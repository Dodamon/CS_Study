# 중첩루프조인, 정렬병합조인, 해시조인의 차이

## 조인의 원리

- 앞서 설명한 조인의 종류들은 아래의 조인의 원리들을 기반으로 이루어진다

### 중첩루프조인

- 중첩 for문과 같은 원리로 조건에 맞는 조인을 하는 방법
- 랜덤 접근에 대한 비용이 많이 증가하므로 대용량의 테이블에서는 사용하지 않음
- 의사코드(Pseudocode)
    
    ```sql
    for each row in t1 matching reference key {	
        for	each row in t2 matching reference key {		
    	    if row satisfies join conditions, send to client		
    	}	
    }
    ```
    
- 중첩 루프 조인에서 발전한 블록 중첩 루프 조인(BNL, Block Nested Loop)이라는 방식도 있다
    - 테이블을 작은 블록으로 나눠서 블록 하나씩 조인하는 방식

### 정렬병합조인

- 각각의 테이블을 조인할 필드 기준으로 정렬하고 정렬이 끝난 이후에 조인 작업을 수행하는 조인
- 적절한 인덱스가 없고, 대용량의 테이블들을 조인하고, 조인 조건으로 <, > 등 범위 비교 연산자가 있을 경우 사용

### 해시조인

- 해시테이블을 기반으로 하는 조인 방법
- 두 개의 테이블을 조인한다고 했을 때 하나의 테이블이 메모리에 온전히 들어간다면 보통 중첩 루프 조인보다 더 효율적 (메모리보다 크다면 디스크를 사용하는 비용 발생)
- 동등(=) 조인에서만 사용
- MySQL의 경우 MySQL 8.0.18 릴리스와 함께 기능 추가
- MySQL의 해시 조인 단계
    1. 빌드 단계

       ![Untitled](https://user-images.githubusercontent.com/47595515/211582661-3fcf072a-3b70-4e49-a83c-7a3b3b40c9db.png)
        
        - 입력 테이블 중 하나를 기반으로 메모리 내에 해시 테이블을 빌드하는 단계
        - 두 테이블 중 용량이 더 작은 테이블을 기반으로 테이블을 빌드
        - 조인에 사용되는 필드가 해시 테이블의 키로 사용
    2. 프로브 단계

       ![Untitled 1](https://user-images.githubusercontent.com/47595515/211582669-666924b6-f109-402e-aa68-5e6b61113043.png)
        
        - 레코드 읽기를 시작
        - 다른 테이블에서 일치하는 레코드를 해시테이블을 기반으로 찾아서 결과값으로 반환
        - 각 테이블은 한번씩만 읽게 되어 성능이 좋다
        - 사용가능한 메모리양은 시스템 변수 join_buffer_size에 의해 제어되며 런타임시 조정 가능